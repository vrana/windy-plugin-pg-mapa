W.loadPlugin({name:"windy-plugin-pg-mapa",version:"2.1.21",author:"Jakub Vrana",repository:{type:"git",url:"git+https://github.com/vrana/windy-plugin-pg-mapa"},description:"Windy plugin for paragliding takeoffs.",displayName:"Paragliding Mapa"},["broadcast","interpolator","map","store","utils","urls"],(function(t,e,n,i,o,a,r){var s=i.map;function l(){const t=o.get("product");return-1!=["gfs","icon","iconD2","iconEu"].indexOf(t)?t:"ecmwf"}const c={},d={};let p=null;const u={},h={},g={ecmwf:{}};let m=!1;function f(t){const e=L.marker(E(t),{icon:z(M(c[t],null),c[t]),riseOnHover:!0,title:c[t].map((t=>t.name+(t.superelevation?" ("+t.superelevation+" m)":""))).join("\n")});return e.bindPopup(k(t),{minWidth:200,maxWidth:400,autoPan:!1}),e.on("popupopen",(()=>{p=e,v(t),g.ecmwf[t]||r.getMeteogramForecast("ecmwf",Object.assign({step:1},E(t))).then((e=>{g.ecmwf[t]=e.data,d[t].setPopupContent(k(t))}))})),e}function w(){n((t=>{const e=s.getBounds();for(const n in c){const i=c[n].reduce(((t,e)=>Math.max(t,e.flights)),0);if(s.getZoom()>(i>100?4:i>10?7:8)&&e.contains(E(n))){if(d[n]||(d[n]=f(n)),!u[A(n)])if("wind"==o.get("overlay")){const e=t(E(n));u[A(n)]=e&&a.wind2obj(e)}else if(!v(n)&&d[n]._icon){const t=d[n]._icon.src;d[n].setIcon(z(t,c[n]));continue}b(n),d[n].addTo(s)}else d[n]&&d[n].remove()}p&&p.fire("popupopen")}))}function v(t){const e=l();return h[e]=h[e]||{},!!h[e][t]||(r.getPointForecast(e,Object.assign({step:1},E(t)),"detail").then((n=>{h[e][t]=n.data,b(t)})),!1)}function y(t){if(u[A(t)])return u[A(t)];const e=h[l()]&&h[l()][t]&&_(h[l()][t]);return e&&{wind:e.wind,dir:e.windDir}}function b(t){const e=y(t),n=S(c[t],e);d[t].setIcon(z(M(c[t],e),c[t])),d[t].setOpacity("red"!=n&&"silver"!=n?1:.6),d[t].setPopupContent(k(t))}function x(t){return/paragliding-mapa\.cz/.test(t)?' <a href="'+t+'" target="_blank"><img src="https://www.paragliding-mapa.cz/favicon/favicon-32x32.png" width="12" height="12" alt="" title="Paragliding Mapa"></a>':/dhv\.de/.test(t)?' <a href="'+t+'" target="_blank"><img src="https://www.dhv.de/fileadmin/templates/dhv2011/img/favicon/dhv.ico" width="12" height="12" alt="" title="DHV"></a>':/paraglidingearth\.com/.test(t)?' <a href="'+t+'" target="_blank"><img src="https://www.paraglidingearth.com/assets/img/favicon.ico" width="12" height="12" alt="" title="Paragliding Earth"></a>':""}function k(t){const e=c[t],n=l(),i=y(t),a=h[n]&&h[n][t],r=g.ecmwf[t],s=["green","orange","gray","red"],p=e.map((t=>'<b style="font-size: 1.25em;'+(t.name.length>=20?'text-overflow: ellipsis; max-width: 180px; display: inline-block; overflow: hidden; vertical-align: text-bottom;" title="'+H(t.name):"")+'"><a'+function(t){return' href="'+t.url+'" target="_blank"'}(t)+(C(t)?' style="color: red;"'+(4==t.flying_status?' title="'+W("flying forbidden","létání zakázáno")+'"':""):"")+">"+H(t.name)+"</a></b>"+(e.length>1?' <img src="'+M([t],i,s)+'" width="12" height="12" alt="">':"")+[t.url].concat(t.urls||[]).map(x).join("")+(t.altitude?' <span title="'+W("elevation","nadmořská výška")+'">'+t.altitude+" "+W("masl","mnm")+"</span>":"")+(t.superelevation?' (<span title="'+W("vertical metre","převýšení")+'">'+t.superelevation+" m</span>)":"")+(t.parkings&&t.parkings.length?t.parkings.map((e=>' <a href="https://www.google.com/maps/dir/?api=1&destination='+e.latitude+","+e.longitude+'" target="_blank"><img src="https://www.google.com/images/branding/product/ico/maps15_bnuw3a_32dp.ico" width="12" height="12" alt="" title="'+W("parking","parkoviště")+H(e.name==t.name&&1==t.parkings.length?"":" "+e.name)+'" style="vertical-align: middle;"></a>')).join(""):' <a href="https://www.google.com/maps/dir/?api=1&destination='+t.latitude+","+t.longitude+'" target="_blank"><img src="https://www.google.com/images/branding/product/ico/maps15_bnuw3a_32dp.ico" width="12" height="12" alt="" title="'+W("takeoff","startovačka")+'" style="vertical-align: middle;"></a>')+' <a href="https://mapy.cz/turisticka?source=coor&id='+t.longitude+","+t.latitude+'" target="_blank"><img src="https://mapy.cz/img/favicon/favicon.ico" width="12" height="12" alt="" title="'+W("takeoff","startovačka")+'" style="vertical-align: middle;"></a>')),u=a&&!/FAKE/.test(a.header.note)&&_(a);let f,w=[];if(i){const n=" "+("surface"==o.get("level")||"wind"!=o.get("overlay")?W("on surface","na zemi"):W("at","v")+" "+o.get("level"));w.push("<a"+function(t){return' href=\'javascript:W.broadcast.fire("rqstOpen", "detail", '+JSON.stringify(Object.assign(E(t),{display:"wind"}))+");'"}(t)+'><span style="color: '+s[P(e,i.dir)]+';" title="'+W("wind direction","směr větru")+n+'"><span style="display: inline-block; transform: rotate('+i.dir+'deg)">↓</span> '+i.dir+'°</span> <span style="color: '+s[j(i.wind)]+';" title="'+W("wind speed","rychlost větru")+n+'">'+i.wind.toFixed(1)+" m/s"+(u&&null!=u.gust?',</span> <span style="color: '+s[j(u.gust-4)]+';" title="'+W("gusts on surface","nárazy na zemi")+'">G: '+u.gust.toFixed(1)+" m/s":"")+"</span></a>")}if(u){const e=new Date(a.header.sunrise).getHours(),i=new Date(a.header.sunset).getHours(),o=u.icon2+(u.hour>e&&u.hour<=i?"":"_night_"+u.moonPhase);w.push("<a"+function(t){return' href=\'javascript:W.broadcast.fire("rqstOpen", "detail", '+JSON.stringify(Object.assign(E(t),{display:"meteogram"}))+");'"}(t)+'><img src="https://www.windy.com/img/icons4/png_25px/'+o+'.png" style="height: 1.3em; vertical-align: middle;" title="'+W("weather","počasí")+" "+n+'"></a>'+(u.mm?' <span title="'+W("precipitation","srážky")+'">'+u.mm+" mm</span>":""))}function v(t,e,n){const i=(t||"").matchAll(/(https?:\/\/[^\s,;]+\w)( \([^()]+\))?/g);Array.from(i).forEach((t=>w.push('<a href="'+H(t[1])+'" class="iconfont" style="vertical-align: middle;" title="'+e+H(t[2]||"")+'" target="_blank">'+n+"</a>")))}p.push(w.join(" ")),w=[],v(e[0].link_meteo,W("weather station","meteostanice"),""),v(e[0].link_webcam,W("webcam","webkamera"),"l"),e.some((t=>f=[t.url].concat(t.urls||[]).find((t=>/xcontest\.org/.test(t))))),w.push('<a href="'+(f||"https://www.xcontest.org/world/en/flights-search/?list[sort]=pts&filter[point]="+t.replace(/(.+) (.+)/,"$2+$1")+"&filter[radius]=2000&filter[date_mode]=period#filter-mode")+'" target="_blank"><img src="https://s.xcontest.org/img/xcontest.gif" width="25" height="12" alt="XContest" style="vertical-align: middle;"></a>'+(null!=e[0].flights?' <span title="'+W("per year","za rok")+'">('+e[0].flights+" "+W("flights","letů")+")</span>,":""));let b=e[0].name;if(e.length>1){const t={};for(const n of e)n.name.split(/[- ,.]+/).forEach((e=>t[e]=(t[e]||0)+1));const n=Object.keys(t).filter((n=>t[n]==e.length));b=n.length?n.join(" "):b}const S=o.get("path").replace(/(\d{4})\/?(\d{2})\/?(\d{2})\/?(\d+)/,((t,e,n,i,o)=>e+"-"+n+"-"+i+"T"+String(3*Math.round(o/3)).padStart(2,0)+":00:00Z")),[q,z]=r?function(t){const{header:e,data:n}=t,i=N(t),o=e.modelElevation;let a=n["temp-surface"][i];const r=o+122*(a-n["dewpoint-surface"][i]),s={temp:{},gh:{}};for(const t in n){const e=/^(temp|gh)-(\d+)h$/.exec(t);e&&(s[e[1]][e[2]]=n[t][i])}let l=o,c=a;return Object.keys(s.temp).sort(((t,e)=>e-t)).some((t=>{const e=s.gh[t];if(e>l){const n=s.temp[t],i=e-l;if(n>a-.01*i)return l+=(a-c)/((n-c)/i+.01),!0;a-=.01*i,l=e,c=n}})),[Math.min(l,r),l>r]}(r):[0,!1];w.push((z?W("Cloud base","Základny"):W("Cloudless","Bezoblačná"))+': <a class="climb" href="http://www.xcmeteo.net/?p='+t.replace(/(.+) (.+)/,"$2x$1")+",t="+S+",s="+encodeURIComponent(b)+'" target="_blank" title="'+(r?W("source","zdroj")+": Windy "+r.header.model:"")+'">'+(r?10*Math.round(q/10)+" m":"-")+"</a>"+(m?' <a href="https://pg.vrana.cz/gfs/#explain" target="_blank"><sup>?</sup></a>':"")),p.push(w.join(" "),"");const D=document.createElement("div");D.style.whiteSpace="nowrap",D.innerHTML=p.join("<br>"),r&&(m&&D.appendChild(function(t){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.style.width="435px",e.style.height="420px",e.style.zoom="75%";for(let t=0;t<=400;t+=50)O(e,[[20,t],[420,t]],"#bbb",.5),O(e,[[20+t,0],[20+t,400]],"#bbb",.5);const{header:n,data:i}=t,o=N(t),a={temp:[],dewpoint:[],wind_u:[],wind_v:[]};let r=-1/0;const s=-273.15,l=n.modelElevation,c=4e3+500*Math.floor(l/500);for(const t in i){const e=/^(temp|dewpoint|wind_u|wind_v)-(.+)/.exec(t);if(e){const n="surface"==e[2]?l:i["gh-"+e[2]][o];n>=l&&(a[e[1]].push([i[t][o],(c-n)/10]),"temp"!=e[1]&&"dewpoint"!=e[1]||(r=Math.max(5*Math.ceil((i[t][o]+s)/5),r)))}}for(const t in a)a[t].sort(((t,e)=>e[1]-t[1]));const d=a.temp[0][0],p=l+122*(d-a.dewpoint[0][0]);a.temp=a.temp.map((t=>[420+10*(t[0]+s-r),t[1]])),a.dewpoint=a.dewpoint.map((t=>[420+10*(t[0]+s-r),t[1]]));const u=e.appendChild(document.createElementNS("http://www.w3.org/2000/svg","clipPath"));u.id="clip";u.appendChild(document.createElementNS("http://www.w3.org/2000/svg","polygon")).setAttribute("points","20,0 420,0 420,400 20,400 20,0");const h=e.appendChild(document.createElementNS("http://www.w3.org/2000/svg","g"));h.setAttribute("clip-path","url(#clip)");const g=[0,a.temp[0][1]-(a.temp[0][0]-a.dewpoint[0][0])/.784];g[0]=a.temp[0][0]-.98*(a.temp[0][1]-g[1]),O(h,[a.temp[0],g],"#db5",1),O(h,[g,[g[0]-.98*g[1]*.6,0]],"#db5",1),O(h,[a.dewpoint[0],g],"#db5",1),O(h,a.temp,"#a22",2),O(h,a.dewpoint,"#23a",2),O(h,a.wind_u.map(((t,e)=>[20+25*Math.sqrt(Math.pow(t[0],2)+Math.pow(a.wind_v[e][0],2)),t[1]])),"#293",1.5);for(const t of function(t){let e;const n=[];for(const i of t.wind_u.map(((e,n)=>[(180*Math.atan2(-t.wind_v[n][0],e[0])/Math.PI-90+360)%360,e[1]])))e&&(Math.abs(e[0]-i[0])<=180?n.push([e,i]):(n.push([e,[i[0]+(e[0]<i[0]?-360:360),i[1]]]),n.push([[e[0]+(e[0]<i[0]?360:-360),e[1]],i]))),e=i;return n}(a))O(h,t.map((t=>[20+t[0]/360*400,t[1]])),"#52bea8",1.5,{"stroke-dasharray":"5 5"});O(e,[[20,0],[420,0]],"#555",.5,{"stroke-dasharray":"5 1.5",class:"guideline"}).style.visibility="hidden";for(let t=Math.ceil(l/1e3);t<=c/1e3;t++)F(e,t+"km",15,10+c/10-100*t,"#555");const m={};for(let t=r;t>=r-20;t-=5)m[420-10*(r-t)]={text:t+"°C",color:"#a22"};for(let t=0;t<=6;t+=2)m[20+25*t]={text:t+"m/s",color:"#293"};const f=(180*Math.atan2(-a.wind_v[0][0],a.wind_u[0][0])/Math.PI-90+360)%360;function w(t){const n=20+400*t/360;delete m[n],F(e,"↓",n,415,"#52bea8",{transform:"rotate("+t+","+n+",410)"})}w(45*Math.floor(f/45)),w(45*Math.ceil(f/45));for(const t in m)F(e,m[t].text,t,415,m[t].color);return F(e,t.header.model,395,22,"#999"),F(e,new Date(i.hours[o]).getHours()+":00",395,37,"#999"),F(e,"",395,64,"#555",{class:"height"}),F(e,"",378,79,"#52bea8",{class:"windDir"}),F(e,"",385,79,"#293",{class:"windSpeed","text-anchor":"start"}),F(e,"",395,94,"#a22",{class:"tempDiff"}),e.onmousemove=n=>{const i=parseInt(e.style.zoom)/100,r=n.offsetX/i,s=n.offsetY/i;if(r>=20&&r<=420&&s<=a.temp[0][1]){const n=c-10*s;e.querySelector(".height").textContent=10*Math.round(n/10)+"m",e.querySelector(".windDir").textContent="↓";const i=I(t,"wind_u",o,n),a=I(t,"wind_v",o,n);e.querySelector(".windDir").setAttribute("transform","rotate("+(180*Math.atan2(-a,i)/Math.PI-90+360)%360+",378,74)"),e.querySelector(".windSpeed").textContent=Math.sqrt(Math.pow(i,2)+Math.pow(a,2)).toFixed(1)+"m/s",e.querySelector(".tempDiff").textContent="Δ "+(d-.98*(Math.min(p,n)-l+.6*Math.max(n-p,0))/100-I(t,"temp",o,n)).toFixed(1)+"°C",e.querySelector(".guideline").style.visibility="visible",e.querySelector(".guideline").setAttribute("d","M20 "+s+"L420 "+s)}else e.querySelector(".height").textContent="",e.querySelector(".windDir").textContent="",e.querySelector(".windSpeed").textContent="",e.querySelector(".tempDiff").textContent="",e.querySelector(".guideline").style.visibility="hidden"},e}(r)),D.querySelector(".climb").onclick=()=>(m=!m,d[t].setPopupContent(k(t)),!1));let A=Date.now();return D.onwheel=t=>{Date.now()>A&&(o.set("timestamp",o.get("timestamp")+60*Math.sign(t.deltaY)*60*1e3),A=Date.now()+100)},D}function _(t){let e=0;for(;e<t.data.day.length&&!(t.data.ts[e]>o.get("timestamp"));e++);const n={};for(let i in t.data)n[i]=t.data[i][e-1];return e?n:null}function M(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["lime","yellow","silver","red"];const i=[],o={0:5,1:4,2:1,3:3,"-1":2};for(const a of t)for(const[t,r]of a.wind_usable||[[0,360]]){const s=S([a],e,n),l=(r-t>=359?'<circle cx="19" cy="19" r="18" fill="'+s+'"/>':D(t-90,r-90,38,s))+"\n";i.push([o[n.indexOf(s)],l])}return i.sort(),"data:image/svg+xml;utf8,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="38" height="38">\n'+i.map((t=>t[1])).join("")+'<circle cx="19" cy="19" r="18" stroke="#333" stroke-width="2" fill-opacity="0"/>\n</svg>')}function S(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["lime","yellow","silver","red"];return t.every(C)?"black":e?n[Math.max(j(e.wind),P(t,e.dir))]:"white"}function C(t){return 4==t.flying_status||0==t.active}function j(t){return t.toFixed(1)>=8?3:t.toFixed(1)>=4?1:0}function P(t,e){let n=2;for(const i of t)if(i.wind_usable&&(2==n&&(n=3),!C(i)))for(const[t,o]of i.wind_usable){if(q(e,t,o))return 0;q(e,t,o,10)&&(n=1)}return n}function q(t,e,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return n+=n<e?360:0,t>=e-i&&t<=n+i||t<=n+i-360||t>=e-i+360}function z(t,e){const n=s.getZoom();let i=n>9?38:n>6?19:n>5?9:5;const o=e[0].flights??(e[0].superelevation||0);return o<10?i/=2:o<100&&(i*=3/4),L.icon({iconUrl:t,iconSize:[i,i],iconAnchor:[(i-1)/2,(i-1)/2]})}function D(t,e,n,i){const o=n/2;return'<path d="M'+o+","+o+" L"+(o+o*Math.cos(Math.PI*t/180))+","+(o+o*Math.sin(Math.PI*t/180))+" A"+o+","+o+" 0 "+((e-t+360)%360>180?1:0)+" 1 "+(o+o*Math.cos(Math.PI*e/180))+","+(o+o*Math.sin(Math.PI*e/180))+' Z" fill="'+i+'"/>'}function E(t){const e=/(.+) (.+)/.exec(t);return{lat:+e[1],lon:+e[2]}}function A(t){return("wind"==o.get("overlay")?o.get("product")+":"+o.get("level"):l()+":surface")+":"+o.get("path")+":"+t}function O(t,e,n,i){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("d","M"+e.map((t=>t.join(" "))).join("L"));for(const t in o)a.setAttribute(t,o[t]);return a.style.stroke=n,a.style.strokeWidth=i,a.style.fill="none",t.appendChild(a)}function F(t,e,n,i,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};const r=document.createElementNS("http://www.w3.org/2000/svg","text");r.textContent=e,r.setAttribute("x",n),r.setAttribute("y",i),r.setAttribute("text-anchor","middle");for(const t in a)r.setAttribute(t,a[t]);return r.style.fill=o,t.appendChild(r)}function I(t,e,n,i){const{header:o,data:a}=t;let r={value:1/0},s={key:"surface",value:o.modelElevation};for(const t in a){const e=/^gh-(.+)/.exec(t),o=a[t][n];e&&o&&(o<r.value&&o>i&&(r={key:e[1],value:o}),o>s.value&&o<=i&&(s={key:e[1],value:o}))}const l=a[e+"-"+r.key][n],c=a[e+"-"+s.key][n];return c+(l-c)/(r.value-s.value)*(i-s.value)}function N(t){const{data:e}=t,n=o.get("timestamp");let i=0;for(const t in e.hours){if(e.hours[t]>n)break;i=t}return i}function W(t,e){const n=o.get("lang");return"cs"==("auto"==n?o.get("usedLang"):n)?e:t}function H(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}t.onopen=function(){const t=document.getElementById("open-in-app");t&&(t.style.display="none"),function(){if(Object.keys(c).length)return;fetch("https://pg.vrana.cz/xcontest/pgmapa.php?locale="+W("en","cs")).then((t=>t.json())).then((t=>{const n={};t:for(const e of t.data){e.wind_usable=null!=e.wind_usable_from?[[e.wind_usable_from,e.wind_usable_to]]:e.wind_usable;for(let t=-1;t<=1;t+=2)for(let i=-1;i<=1;i+=2){const o=(e.latitude+t/20).toFixed(1),r=(e.longitude+i/20).toFixed(1);if(n[o+" "+r])for(const t of n[o+" "+r])if(a.isNear(E(t),{lat:e.latitude,lon:e.longitude})){c[t].push(e);continue t}}c[e.latitude+" "+e.longitude]=[e];const t=e.latitude.toFixed(1)+" "+e.longitude.toFixed(1);n[t]=n[t]||[],n[t].push(e.latitude+" "+e.longitude)}s.on("popupclose",(()=>p=null)),w(),e.on("redrawFinished",w)}))}()}}));
